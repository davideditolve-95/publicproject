<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Operatore - MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .match-badge-success {
            background-color: #d1fae5;
            color: #059669;
        }
        .match-badge-danger {
            background-color: #fee2e2;
            color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header & Navigation -->
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">Bridge - Piattaforma Operatore</h1>
            <nav>
                <button onclick="navigate('dashboard')" class="text-sm font-medium py-2 px-3 rounded-lg hover:bg-gray-700 transition duration-150">Dashboard</button>
                <button onclick="navigate('mapping')" class="text-sm font-medium py-2 px-3 rounded-lg hover:bg-gray-700 transition duration-150">Mappatura Risorse</button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="app-content">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </main>

    <script>
        // --- FIREBASE SETUP (Mandatory Global Variables) ---
        // Simulating the mandatory environment variables for Firebase
        const __app_id = 'marimo-mvp-app';
        const __firebase_config = JSON.stringify({ /* config would go here */ });
        const __initial_auth_token = 'simulated-auth-token-operator-123';

        // NOTE: Firebase/Firestore is MANDATORY for real multi-user apps.
        // For this static, single-user MVP simulation, we are using local JS data.
        // A real version would replace this data with Firestore calls.

        const state = {
            view: 'dashboard', // 'dashboard', 'profile', 'mapping'
            currentUser: null
        };

        // --- SIMULATED DATA ---

        const users = [
            {
                id: 'mario_rossi',
                name: 'Mario Rossi',
                sgancio: '15/11/2025',
                needs: {
                    abitazione: { priority: 'Critica', description: 'Non ha un tetto.' },
                    lavoro: { priority: 'Prioritaria', description: 'Necessita indotto economico.' },
                    trasporto: { priority: 'Critica', description: 'Nessun mezzo proprio.' },
                    sociale: { priority: 'Media', description: 'Supporto per reinserimento.' },
                },
                vincoli: {
                    reato: 'Reato X (non violento, non contro minori)',
                    casellario: 'Idoneo per ruoli a contatto con pubblico/minori (verificare in tempo reale)',
                },
                monitoring: [
                    { date: '2025-11-20', status: 'In contatto', note: 'Primo check-in. Trovato alloggio temporaneo con Parrocchia Y.' }
                ],
                status: 'Attivo',
                recidivaRisk: 'Basso',
            },
            {
                id: 'luigi_verdi',
                name: 'Luigi Verdi',
                sgancio: '01/12/2025',
                status: 'Pianificazione',
                recidivaRisk: 'Medio',
                needs: {}, vincoli: {}, monitoring: [],
            },
            {
                id: 'anna_neri',
                name: 'Anna Neri',
                sgancio: '05/01/2026',
                status: 'Attesa',
                recidivaRisk: 'Basso',
                needs: {}, vincoli: {}, monitoring: [],
            }
        ];

        const resources = [
            // Lavoro (Work)
            { id: 1, type: 'lavoro', category: 'Cucina', name: 'Menssa Scolastica "Il Girasole"', description: 'Assistente cuoco, full-time. Richiede casellario pulito per minori.', vincoli: ['NO_REATI_MINORI'], matched: false },
            { id: 2, type: 'lavoro', category: 'Manutenzione', name: 'Cooperativa Edile Alfa', description: 'Aiuto manovale, tirocinio inclusione sociale (TIS).', vincoli: [], matched: true },
            // Abitazione (Housing)
            { id: 3, type: 'abitazione', category: 'Alloggio Sociale', name: 'Casa Accoglienza "Speranza"', description: 'Posto letto in co-housing, canone agevolato. Richiede valutazione psicologica.', vincoli: ['VALUTAZIONE_PSICOLOGICA'], matched: false },
            { id: 4, type: 'abitazione', category: 'Affitto', name: 'Appartamento Tassa Agevolato', description: 'Monolocale, affitto calmierato.', vincoli: [], matched: true },
            // Trasporto (Transport)
            { id: 5, type: 'trasporto', category: 'Mezzi Pubblici', name: 'Abbonamento Annuale TPL', description: 'Biglietto annuale gratuito per reddito ISEE sotto soglia.', vincoli: ['ISEE_SOTTO_SOGLIA'], matched: true },
            // Sociale (Social)
            { id: 6, type: 'sociale', category: 'Volontariato', name: 'Associazione "Il Ponte"', description: 'Attività di volontariato e supporto psicologico. Gruppi di incontro.', vincoli: [], matched: true },
        ];


        // --- RENDERING LOGIC ---

        function render() {
            const contentDiv = document.getElementById('app-content');
            let html = '';

            switch (state.view) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'profile':
                    html = renderProfile(state.currentUser);
                    break;
                case 'mapping':
                    html = renderMapping();
                    break;
                default:
                    html = renderDashboard();
            }
            contentDiv.innerHTML = html;
        }

        function navigate(view, userId = null) {
            state.view = view;
            state.currentUser = users.find(u => u.id === userId) || users[0]; // Default to Mario Rossi
            render();
            window.scrollTo(0, 0); // Scroll to top on navigation
        }

        // --- DASHBOARD VIEW ---
        function renderDashboard() {
            let userListHtml = users.map(user => `
                <div class="card bg-white p-4 rounded-xl flex justify-between items-center mb-4">
                    <div>
                        <p class="text-xl font-semibold text-gray-800">${user.name}</p>
                        <p class="text-sm text-gray-500">Stato: <span class="font-medium ${user.status === 'Attivo' ? 'text-blue-600' : 'text-yellow-600'}">${user.status}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Sgancio: ${user.sgancio}</p>
                        <button onclick="navigate('profile', '${user.id}')" class="mt-2 bg-indigo-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                            Gestisci Caso
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Utenti in Sgancio</h2>
                <p class="text-gray-600 mb-6">Totale Utenti: ${users.length}</p>
                ${userListHtml}
            `;
        }

        // --- PROFILE VIEW ---
        function renderProfile(user) {
            if (!user) return `<p class="text-red-600">Utente non trovato.</p>`;

            // Bisogni Section
            const needsHtml = Object.entries(user.needs).map(([key, item]) => `
                <div class="border-b last:border-b-0 py-3 flex justify-between items-start">
                    <p class="text-lg font-semibold capitalize">${key}</p>
                    <div>
                        <span class="text-sm font-medium ${item.priority === 'Critica' ? 'text-red-600' : (item.priority === 'Prioritaria' ? 'text-orange-600' : 'text-green-600')}">${item.priority}</span>
                        <p class="text-sm text-gray-600 mt-1">${item.description}</p>
                    </div>
                </div>
            `).join('');

            // Monitoring Section
            const monitoringHtml = user.monitoring.map(item => `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <p class="font-medium text-gray-700">${item.date} - ${item.status}</p>
                    <p class="text-sm text-gray-600">${item.note}</p>
                </div>
            `).join('') || '<p class="text-gray-500">Nessun aggiornamento di monitoraggio.</p>';


            return `
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Scheda Caso: ${user.name}</h2>
                    <button onclick="navigate('dashboard')" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                        &larr; Torna alla Dashboard
                    </button>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Column 1: Dettagli -->
                    <div class="md:col-span-1 card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Dettagli Utente</h3>
                        <p class="mb-2"><span class="font-medium">ID Utente:</span> <span class="text-xs font-mono bg-gray-200 p-1 rounded">${user.id}</span></p>
                        <p class="mb-2"><span class="font-medium">Data Sgancio:</span> ${user.sgancio}</p>
                        <p class="mb-2"><span class="font-medium">Rischio Recidiva:</span> <span class="font-bold ${user.recidivaRisk === 'Basso' ? 'text-green-600' : 'text-orange-600'}">${user.recidivaRisk}</span></p>
                        <h4 class="font-medium mt-4">Vincoli (Casellario/Reato):</h4>
                        <p class="text-sm text-gray-700">${user.vincoli.reato}</p>
                        <p class="text-sm text-gray-700 mt-1">Check Casellario: ${user.vincoli.casellario}</p>
                    </div>

                    <!-- Column 2: Bisogni -->
                    <div class="md:col-span-2 card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Bisogni Primari & Secondari</h3>
                        ${needsHtml}
                        <button onclick="navigate('mapping', '${user.id}')" class="mt-6 w-full bg-emerald-500 text-white py-3 rounded-lg text-lg font-semibold hover:bg-emerald-600 transition duration-200">
                            Avvia Matching con Risorse & Servizi
                        </button>
                    </div>

                    <!-- Column 3: Monitoraggio (Full Width) -->
                    <div class="md:col-span-3 card bg-white p-6 rounded-xl mt-6">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Monitoraggio & Note Operative</h3>
                        ${monitoringHtml}
                        <textarea class="w-full border border-gray-300 p-3 rounded-lg mt-4" rows="3" placeholder="Aggiungi una nuova nota operativa o un promemoria per il dispositivo X..."></textarea>
                        <button class="mt-3 bg-blue-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-600">Salva Aggiornamento</button>
                    </div>
                </div>
            `;
        }

        // --- MAPPING VIEW ---
        function renderMapping() {
            const user = state.currentUser;
            if (!user) return `<p class="text-red-600">Seleziona un utente dalla Dashboard.</p>`;

            const needsList = Object.keys(user.needs);

            const resourcesHtml = resources.map(resource => {
                let match = true;
                let matchMessage = 'Idoneo';

                // SIMULAZIONE DI SICUREZZA E VINCOLI (Come discusso nella riunione)
                if (resource.vincoli.includes('NO_REATI_MINORI') && user.vincoli.casellario.includes('non contro minori')) {
                    // Questa è una SIMULAZIONE! In realtà andrebbe bloccato per sicurezza se fosse un reato contro minori.
                    // Qui stiamo simulando un CASO SFAVOREVOLE per dimostrare il blocco.
                    // Se il reato è X (non violento, non contro minori) il check è OK.
                    // Se la risorsa richiede NO_REATI_MINORI, e Mario NON ha quei reati, è OK.
                    // Però simuliamo il blocco per mostrare la funzionalità.
                    if (resource.name.includes('Scolastica')) {
                        match = false;
                        matchMessage = 'BLOCCO SICUREZZA: Vincoli di reato/casellario non idonei per ruoli a contatto con minori.';
                    }
                }
                
                const matchBadgeClass = match ? 'match-badge-success' : 'match-badge-danger';
                const buttonClass = match ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-400 cursor-not-allowed';
                const buttonDisabled = match ? '' : 'disabled';
                const buttonText = match ? 'Proponi su Dispositivo X' : 'Bloccato';


                return `
                    <div class="card bg-white p-5 rounded-xl border border-gray-200 mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-xl font-semibold text-gray-800">${resource.name}</h4>
                                <p class="text-sm font-medium text-gray-500 uppercase mt-1">${resource.type} - ${resource.category}</p>
                            </div>
                            <span class="text-xs font-bold py-1 px-3 rounded-full ${matchBadgeClass}">${matchMessage}</span>
                        </div>
                        <p class="text-gray-600 mt-2">${resource.description}</p>
                        <div class="mt-4 flex justify-between items-center pt-2 border-t border-gray-100">
                            <span class="text-sm text-gray-500">Vincoli richiesti: ${resource.vincoli.length > 0 ? resource.vincoli.join(', ') : 'Nessuno'}</span>
                            <button class="text-white text-sm py-2 px-4 rounded-lg transition duration-200 ${buttonClass}" ${buttonDisabled}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Matching Risorse per ${user.name}</h2>
                    <button onclick="navigate('profile', '${user.id}')" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                        &larr; Torna alla Scheda Caso
                    </button>
                </div>

                <div class="card bg-white p-6 rounded-xl mb-6">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Bisogni in Evidenza</h3>
                    <div class="flex flex-wrap gap-4">
                        ${needsList.map(need => `<span class="bg-red-100 text-red-700 px-3 py-1 text-sm rounded-full font-medium">${need.toUpperCase()}</span>`).join('')}
                    </div>
                </div>

                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Risorse Territoriali Mappate (${resources.length})</h3>
                <p class="text-gray-600 mb-6">Filtra per necessità:
                    ${needsList.map(need => `<button class="ml-2 bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full hover:bg-gray-300 transition duration-150">${need.toUpperCase()}</button>`).join('')}
                </p>

                ${resourcesHtml}
            `;
        }


        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for a specific user to display (default to Mario Rossi)
            state.currentUser = users[0];
            render();
        });

    </script>

</body>
</html>
